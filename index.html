<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat v6 — 단일파일</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --text-color:#1e293b; --accent:#2563eb; --muted:#6b7280; --border:rgba(15,23,42,0.06);
    --mention-bg:#fff7cc; --reply-bg:#ecfdf5;
    --own-bubble-bg:#e0f2ff;
  }
  html.dark{
    --bg:#061022;--card:#0b1220;--text-color:#e2e8f0;--accent:#3b82f6;--muted:#9aa3b2;--border:rgba(255,255,255,0.06);
    --mention-bg:#2b2a0f;--reply-bg:#063b1f;
    --own-bubble-bg:#0f3f6e;
  }
  body{background:var(--bg);font-family:Inter,system-ui,'Noto Sans KR',sans-serif;color:var(--text-color);margin:0;padding:18px}
  .app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(2,6,23,0.06);border:1px solid var(--border)}
  .avatar{width:44px;height:44px;border-radius:999px;object-fit:cover;border:1px solid var(--border);cursor:pointer}
  .btn{background:var(--accent);color:white;padding:.5rem .8rem;border-radius:10px;border:0;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--border);padding:.4rem .6rem;border-radius:10px;cursor:pointer}
  .rooms{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:64vh;overflow:auto;padding-right:8px}
  .room-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer;transition:background .12s}
  .room-item:hover{background:rgba(0,0,0,0.03)}
  .chat-area{display:flex;flex-direction:column;height:80vh}
  .chat-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .chat-body{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:8px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
  .msg-block{display:flex;gap:10px;align-items:flex-start}
  .msg-block.own{flex-direction:row-reverse}
  .avatar-col{width:44px}
  .bubble{display:inline-block;padding:10px;border-radius:12px;min-width:90px;max-width:68%;word-break:break-word;white-space:pre-wrap;border:1px solid var(--border);background:var(--card);margin-bottom:4px}
  .bubble.own{background:var(--own-bubble-bg);border-color:rgba(37,99,235,0.12)}
  .messages-stack{display:flex;flex-direction:column;align-items:flex-start}
  .msg-block.own .messages-stack{align-items:flex-end}
  .meta-line{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;align-items:center}
  .controls{opacity:0;transition:opacity .12s;display:flex;gap:6px;align-items:center}
  .msg-block:hover .controls{opacity:1}
  .icon-btn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:8px;color:inherit}
  .icon-btn.delete:hover{color:#ef4444}
  .mention-inline{background:transparent;color:#6b4b00;font-weight:700;padding:2px 6px;border-radius:6px}
  .mention-highlight{background:var(--mention-bg);border-radius:8px;padding:6px}
  .reply-small{background:var(--reply-bg);border-radius:6px;padding:6px;margin-bottom:8px;color:inherit}
  .reply-preview{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--reply-bg)}
  .invite-list{margin-top:12px;border-top:1px dashed var(--border);padding-top:8px}
  .invite-item{display:flex;justify-content:space-between;padding:6px;border-radius:8px;background:rgba(0,0,0,0.02);align-items:center;margin-bottom:6px}
  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--card);padding:16px;border-radius:12px;border:1px solid var(--border);width:420px}
  @media(max-width:920px){.app{grid-template-columns:1fr}.rooms{display:none}}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;position:relative">
      <img id="profileAvatar" class="avatar" src="https://placehold.co/88" />
      <div>
        <div id="displayName" style="font-weight:600">비회원</div>
        <div id="displayTag" class="text-sm text-gray-500">#—</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="darkToggle" class="btn-ghost" style="font-size:12px">다크 모드</button>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="openCreateRoom" class="btn" style="flex:1">방 생성</button>
    </div>

    <div id="roomsList" class="rooms"></div>
  </div>

  <div class="card chat-area">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <div id="roomTitle" style="font-weight:700">— 방 선택 —</div>
          <div id="roomInfo" class="text-sm text-gray-500"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="roomMembers" class="text-sm text-gray-500"></div>
        <button id="leaveRoom" class="btn-ghost" style="display:none">방 나가기</button>
      </div>
    </div>

    <div id="chatBody" class="chat-body"></div>

    <div id="replyPreview" class="reply-preview" style="display:none;margin-top:10px">
      <div><strong>답장</strong> <span id="replyText" class="text-sm"></span></div>
      <div><button id="cancelReply" class="btn-ghost">취소</button></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <input id="msgInput" placeholder="메시지 입력..." style="flex:1;padding:.6rem;border-radius:10px;border:1px solid var(--border)"/>
      <input id="fileInput" type="file" style="display:none" />
      <button id="attachBtn" class="icon-btn" style="font-size:18px">📎</button>
      <button id="sendBtn" class="btn">전송</button>
    </div>
  </div>
</div>

<div id="modals"></div>
<div id="toastArea" style="position:fixed;right:18px;top:18px;z-index:70"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyA67fYuBMY3vDQ5DpC5VXnzC1tkw7oBZfQ",authDomain:"chat-29b71.firebaseapp.com",databaseURL:"https://chat-29b71-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"chat-29b71",storageBucket:"chat-29b71.appspot.com",messagingSenderId:"838945499737",appId:"1:838945499737:web:bc4d105d8189837c4e9f48",measurementId:"G-WW5Q1HPS8P"};firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database(),storage=firebase.storage();
const profileAvatar=document.getElementById('profileAvatar'),displayNameEl=document.getElementById('displayName'),displayTagEl=document.getElementById('displayTag'),darkToggle=document.getElementById('darkToggle'),roomsList=document.getElementById('roomsList'),openCreateRoom=document.getElementById('openCreateRoom'),chatBody=document.getElementById('chatBody'),msgInput=document.getElementById('msgInput'),sendBtn=document.getElementById('sendBtn'),attachBtn=document.getElementById('attachBtn'),fileInput=document.getElementById('fileInput'),replyPreview=document.getElementById('replyPreview'),replyText=document.getElementById('replyText'),cancelReply=document.getElementById('cancelReply'),leaveRoomBtn=document.getElementById('leaveRoom'),roomTitle=document.getElementById('roomTitle'),roomInfo=document.getElementById('roomInfo');
let currentRoom=null,messagesRef=null,messageListener=null,selectedFile=null,replyTo=null;
const MSG_LIMIT=1000;
const now=()=>Date.now();function uid(){return'u'+Math.random().toString(36).slice(2,9)}function escapeHtml(s){return s?s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'):''}
function toast(msg,t=2800){const n=document.createElement('div');n.className='card';n.style.marginBottom='8px';n.textContent=msg;document.getElementById('toastArea').appendChild(n);setTimeout(()=>n.remove(),t);}
function getLocalProfile(){return JSON.parse(localStorage.getItem('local_profile')||'{}')}function setLocalProfile(p){localStorage.setItem('local_profile',JSON.stringify(p))}
darkToggle.addEventListener('click',()=>{document.documentElement.classList.toggle('dark');darkToggle.textContent=document.documentElement.classList.contains('dark')?'라이트 모드':'다크 모드';localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light')});
if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&window.matchMedia('(prefers-color-scheme: dark)').matches)){document.documentElement.classList.add('dark');darkToggle.textContent='라이트 모드'}else{darkToggle.textContent='다크 모드'}

openCreateRoom.addEventListener('click',()=>openCreateRoomModal());
function openCreateRoomModal(){
  const m=openModal(`<div style="display:flex;flex-direction:column;gap:8px"><div style="font-weight:700">방 생성</div><input id="newRoomName" placeholder="방 이름" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/><div style="display:flex;justify-content:flex-end;gap:8px"><button id="createCancel" class="btn-ghost">취소</button><button id="createOk" class="btn">생성</button></div></div>`);
  m.querySelector('#createCancel').onclick=()=>m.remove();
  m.querySelector('#createOk').onclick=async()=>{const n=m.querySelector('#newRoomName').value.trim();if(!n)return toast('방 이름 입력');const rid='r_'+Math.random().toString(36).slice(2,8);const me=auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;await db.ref('rooms/'+rid).set({id:rid,name:n,createdAt:now(),owner:me,members:{[me]:true}});m.remove();loadRooms();}
}
function openModal(html){const m=document.createElement('div');m.className='modal-backdrop';m.innerHTML=`<div class="modal">${html}</div>`;m.onclick=e=>{if(e.target===m)m.remove()};document.getElementById('modals').appendChild(m);return m;}
async function loadRooms(){const s=await db.ref('rooms').once('value');const data=s.val()||{};roomsList.innerHTML='';const my=auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;Object.keys(data).forEach(id=>{const r=data[id];const el=document.createElement('div');el.className='room-item';el.dataset.id=id;el.innerHTML=`<img class="avatar" src="${r.thumb||'https://placehold.co/36'}"/><div style="flex:1"><div style="font-weight:600">${r.name}</div><div class="text-sm text-gray-500">${r.lastMessage?escapeHtml(r.lastMessage.slice(0,48)):'설명 없음'}</div></div>`;const act=document.createElement('div');act.style.marginLeft='8px';const invite=document.createElement('button');invite.className='icon-btn';invite.textContent='➕';invite.title='초대';invite.onclick=e=>{e.stopPropagation();openInviteModal(id)};const edit=document.createElement('button');edit.className='icon-btn';edit.textContent='⚙️';edit.title='설정';edit.onclick=e=>{e.stopPropagation();openEditRoomNameModal(id,r.name)};act.appendChild(invite);act.appendChild(edit);el.appendChild(act);el.addEventListener('click',()=>selectRoom(id));roomsList.appendChild(el)})}
function openInviteModal(id){const m=openModal(`<div style="display:flex;flex-direction:column;gap:8px"><div style="font-weight:700">초대</div><input id="inviteTag" placeholder="상대 태그 입력" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/><div style="display:flex;justify-content:flex-end;gap:8px"><button id="inviteCancel" class="btn-ghost">취소</button><button id="inviteSend" class="btn">보내기</button></div></div>`);m.querySelector('#inviteCancel').onclick=()=>m.remove();m.querySelector('#inviteSend').onclick=async()=>{const tag=m.querySelector('#inviteTag').value.trim().toLowerCase();if(!tag)return toast('태그 입력');const t=await db.ref('tags/'+tag).once('value');if(!t.exists())return toast('해당 유저 없음');const uid=t.val();await db.ref('rooms/'+id+'/members/'+uid).set(true);toast('추가 완료');m.remove();}}
function openEditRoomNameModal(id,n){const m=openModal(`<div style="display:flex;flex-direction:column;gap:8px"><div style="font-weight:700">방 이름 수정</div><input id="editRoomName" value="${n}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/><div style="display:flex;justify-content:flex-end;gap:8px"><button id="editCancel" class="btn-ghost">취소</button><button id="editOk" class="btn">수정</button></div></div>`);m.querySelector('#editCancel').onclick=()=>m.remove();m.querySelector('#editOk').onclick=async()=>{const nn=m.querySelector('#editRoomName').value.trim();if(!nn)return toast('이름 입력');await db.ref('rooms/'+id).update({name:nn});m.remove();loadRooms();}}

async function selectRoom(id){if(messagesRef&&messageListener)messagesRef.off('child_added',messageListener);currentRoom=id;chatBody.innerHTML='';roomTitle.textContent='로딩중';const rs=await db.ref('rooms/'+id).once('value');const meta=rs.val()||{};roomTitle.textContent=meta.name||'방';leaveRoomBtn.style.display='inline-block';messagesRef=db.ref('rooms/'+id+'/messages');messageListener=messagesRef.limitToLast(MSG_LIMIT).on('child_added',snap=>insertMessage(Object.assign({key:snap.key},snap.val())));}
function insertMessage(m){const l=chatBody.lastElementChild;const me=getLocalProfile();const my=auth.currentUser?auth.currentUser.uid:me.uid;const isMe=m.uid===my;if(l&&l.dataset.author===(m.uid||m.author)&&m.ts-Number(l.dataset.lastTs)<300000){appendBubble(l.querySelector('.messages-stack'),m,isMe);l.dataset.lastTs=m.ts}else{const b=document.createElement('div');b.className='msg-block'+(isMe?' own':'');b.dataset.author=m.uid||m.author;b.dataset.lastTs=m.ts;const av=document.createElement('div');av.className='avatar-col';const i=document.createElement('
