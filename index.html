<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat v6 â€” ë‹¨ì¼íŒŒì¼</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Root variables for theming */
  :root{
    --bg:#f4f7fb; --card:#fff; --text-color:#1e293b; --accent:#2563eb; --muted:#6b7280; --border:rgba(15,23,42,0.06);
    --mention-bg:#fff7cc; --reply-bg:#ecfdf5;
    /* Custom: Solid colors for owned bubble */
    --own-bubble-bg:#e0f2ff; 
  }
  html.dark{
    --bg:#061022;--card:#0b1220;--text-color:#e2e8f0;--accent:#3b82f6;--muted:#9aa3b2;--border:rgba(255,255,255,0.06);
    --mention-bg:#2b2a0f;--reply-bg:#063b1f;
    /* Custom: Solid colors for owned bubble */
    --own-bubble-bg:#0f3f6e;
  }
  body{
    background:var(--bg);
    font-family:Inter,system-ui,'Noto Sans KR',sans-serif;
    color:var(--text-color); /* <-- ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
    margin:0;padding:18px
  }
  .app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(2,6,23,0.06);border:1px solid var(--border)}
  .avatar{width:44px;height:44px;border-radius:999px;object-fit:cover;border:1px solid var(--border);cursor:pointer}
  .btn{background:var(--accent);color:white;padding:.5rem .8rem;border-radius:10px;border:0;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--border);padding:.4rem .6rem;border-radius:10px;cursor:pointer}
  .rooms{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:64vh;overflow:auto;padding-right:8px}
  .room-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer;transition:background .12s}
  .room-item:hover{background:rgba(0,0,0,0.03)}
  .chat-area{display:flex;flex-direction:column;height:80vh}
  .chat-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .chat-body{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:8px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
  /* message */
  .msg-block{display:flex;gap:10px;align-items:flex-start}
  .msg-block.own{flex-direction:row-reverse}
  .avatar-col{width:44px}
  .bubble{
    display:inline-block;padding:10px;border-radius:12px;min-width:90px;max-width:68%;word-break:break-word;white-space:pre-wrap;
    border:1px solid var(--border);background:var(--card);
    margin-bottom: 4px; /* <--- ì—°ì†ëœ ë©”ì‹œì§€ ì„¸ë¡œ ê°„ê²© ì¶”ê°€ */
  }
  .bubble.own{
    background:var(--own-bubble-bg); /* <-- ê·¸ë¼ë°ì´ì…˜ ì œê±°, ë‹¨ìƒ‰ ë°°ê²½ */
    border-color:rgba(37,99,235,0.12);
  }
  /* ì—°ì†ëœ ë©”ì‹œì§€ ì„¸ë¡œ ì •ë ¬ */
  .messages-stack{
    display: flex;
    flex-direction: column; /* <-- ì„¸ë¡œ ì •ë ¬ */
    align-items: flex-start;
  }
  .msg-block.own .messages-stack{
    align-items: flex-end;
  }

  .meta-line{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;align-items:center}
  .controls{opacity:0;transition:opacity .12s;display:flex;gap:6px;align-items:center}
  .msg-block:hover .controls{opacity:1}
  .icon-btn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:8px;color:inherit}
  .icon-btn.delete:hover{color:#ef4444}
  .mention-inline{background:transparent;color:#6b4b00;font-weight:700;padding:2px 6px;border-radius:6px}
  .mention-highlight{background:var(--mention-bg);border-radius:8px;padding:6px}
  .reply-small{background:var(--reply-bg);border-radius:6px;padding:6px;margin-bottom:8px;color:inherit}
  /* reply preview above input */
  .reply-preview{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--reply-bg)}
  /* invite list left bottom */
  .invite-list{margin-top:12px;border-top:1px dashed var(--border);padding-top:8px}
  .invite-item{display:flex;justify-content:space-between;padding:6px;border-radius:8px;background:rgba(0,0,0,0.02);align-items:center;margin-bottom:6px}
  /* modal */
  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--card);padding:16px;border-radius:12px;border:1px solid var(--border);width:420px}
  /* small responsive */
  @media(max-width:920px){ .app{grid-template-columns:1fr} .rooms{display:none} }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;position:relative">
      <img id="profileAvatar" class="avatar" src="https://placehold.co/88" />
      <div>
        <div id="displayName" style="font-weight:600">ë¹„íšŒì›</div>
        <div id="displayTag" class="text-sm text-gray-500">#â€”</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="darkToggle" class="btn-ghost" style="font-size:12px">ë‹¤í¬ ëª¨ë“œ</button>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="openCreateRoom" class="btn" style="flex:1">ë°© ìƒì„±</button>
    </div>

    <div id="roomsList" class="rooms"></div>

    <div class="invite-list" id="inviteListWrap" style="display:none">
      <div class="text-sm text-gray-500 mb-2">ì´ˆëŒ€ ì•Œë¦¼</div>
      <div id="inviteList"></div>
    </div>
  </div>

  <div class="card chat-area">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <div id="roomTitle" style="font-weight:700">â€” ë°© ì„ íƒ â€”</div>
          <div id="roomInfo" class="text-sm text-gray-500"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="roomMembers" class="text-sm text-gray-500"></div>
        <button id="leaveRoom" class="btn-ghost" style="display:none">ë°© ë‚˜ê°€ê¸°</button>
      </div>
    </div>

    <div id="chatBody" class="chat-body"></div>

    <div id="replyPreview" class="reply-preview" style="display:none;margin-top:10px">
      <div><strong>ë‹µì¥</strong> <span id="replyText" class="text-sm"></span></div>
      <div><button id="cancelReply" class="btn-ghost">ì·¨ì†Œ</button></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <input id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥. @íƒœê·¸ë¡œ ë©˜ì…˜" style="flex:1;padding:.6rem;border-radius:10px;border:1px solid var(--border)"/>
      <input id="fileInput" type="file" style="display:none" />
      <button id="attachBtn" class="icon-btn" style="font-size:20px;font-weight:900">ğŸ”—</button>
      <button id="sendBtn" class="btn">ì „ì†¡</button>
    </div>
  </div>
</div>

<div id="modals"></div>
<div id="toastArea" style="position:fixed;right:18px;top:18px;z-index:70"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
/* ========== CONFIG ========== */
// ë„¤ê°€ ì¤€ config ê·¸ëŒ€ë¡œ ë„£ìŒ
const firebaseConfig = {
  apiKey: "AIzaSyA67fYuBMY3vDQ5DpC5VXnzC1tkw7oBZfQ",
  authDomain: "chat-29b71.firebaseapp.com",
  databaseURL: "https://chat-29b71-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-29b71",
  storageBucket: "chat-29b71.appspot.com",
  messagingSenderId: "838945499737",
  appId: "1:838945499737:web:bc4d105d8189837c4e9f48",
  measurementId: "G-WW5Q1HPS8P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
/* ============================ */

const profileAvatar = document.getElementById('profileAvatar');
const displayNameEl = document.getElementById('displayName');
const displayTagEl = document.getElementById('displayTag');
const darkToggle = document.getElementById('darkToggle');
const roomsList = document.getElementById('roomsList');
const openCreateRoom = document.getElementById('openCreateRoom');
const inviteList = document.getElementById('inviteList');
const chatBody = document.getElementById('chatBody');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const replyPreview = document.getElementById('replyPreview');
const replyText = document.getElementById('replyText');
const cancelReply = document.getElementById('cancelReply');
const leaveRoomBtn = document.getElementById('leaveRoom');
const roomTitle = document.getElementById('roomTitle');
const roomInfo = document.getElementById('roomInfo');
const roomMembers = document.getElementById('roomMembers');

let currentRoom = null;
let messagesRef = null;
let messageListener = null;
let selectedFile = null;
let replyTo = null;
let lastAuthor = null;
const MSG_LIMIT = 1000;

// helper
const now = ()=>Date.now();
function uid(){ return 'u'+Math.random().toString(36).slice(2,9) }
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function toast(msg, t=2800){ const n=document.createElement('div'); n.className='card'; n.style.marginBottom='8px'; n.textContent=msg; document.getElementById('toastArea').appendChild(n); setTimeout(()=>{ n.remove() }, t); }
function getLocalProfile(){ return JSON.parse(localStorage.getItem('local_profile')||'{}'); }
function setLocalProfile(p){ localStorage.setItem('local_profile', JSON.stringify(p)); }

/* ---------- UI behavior ---------- */
darkToggle.addEventListener('click', ()=>{ 
  document.documentElement.classList.toggle('dark'); 
  darkToggle.textContent = document.documentElement.classList.contains('dark') ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ';
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
});

// Initial theme check
if(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
  document.documentElement.classList.add('dark');
  darkToggle.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ';
} else {
  darkToggle.textContent = 'ë‹¤í¬ ëª¨ë“œ';
}

// profile click -> modal (persistent)
profileAvatar.addEventListener('click', ()=> openProfileModal() );

/* ---------- Modals (Functions unchanged from previous version, omitted for brevity) ---------- */
function openModal(html){ 
  const m = document.createElement('div'); m.className='modal-backdrop';
  m.innerHTML = `<div class="modal">${html}</div>`;
  m.onclick = (e)=>{ if(e.target===m) m.remove(); };
  document.getElementById('modals').appendChild(m);
  return m;
}
function closeModals(){ document.getElementById('modals').innerHTML=''; }

/* Generic Custom Modals */
function openConfirmModal(title, text){
  return new Promise(resolve => {
    const modal = openModal(`<div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:700">${title}</div>
      <div>${text}</div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="confirmCancel" class="btn-ghost">ì·¨ì†Œ</button>
        <button id="confirmOk" class="btn">í™•ì¸</button>
      </div>
    </div>`);
    modal.querySelector('#confirmCancel').onclick = ()=> { modal.remove(); resolve(false); };
    modal.querySelector('#confirmOk').onclick = ()=> { modal.remove(); resolve(true); };
  });
}

function openEditMessageModal(currentText){
  return new Promise(resolve => {
    const modal = openModal(`<div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:700">ë©”ì‹œì§€ ìˆ˜ì •</div>
      <textarea id="editMsgText" style="padding:.6rem;border-radius:8px;border:1px solid var(--border);min-height:100px">${currentText}</textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="editCancel" class="btn-ghost">ì·¨ì†Œ</button>
        <button id="editOk" class="btn">ìˆ˜ì •</button>
      </div>
    </div>`);
    modal.querySelector('#editCancel').onclick = ()=> { modal.remove(); resolve(null); };
    modal.querySelector('#editOk').onclick = ()=>{
      const newText = modal.querySelector('#editMsgText').value;
      modal.remove();
      resolve(newText);
    };
  });
}

async function openEditRoomNameModal(roomId, currentName){
  return new Promise(resolve => {
    const modal = openModal(`<div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:700">ë°© ì´ë¦„ ìˆ˜ì •</div>
      <input id="editRoomName" placeholder="ë°© ì´ë¦„" value="${currentName}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="editCancel" class="btn-ghost">ì·¨ì†Œ</button>
        <button id="editOk" class="btn">ìˆ˜ì •</button>
      </div>
    </div>`);
    modal.querySelector('#editCancel').onclick = ()=> { modal.remove(); resolve(); };
    modal.querySelector('#editOk').onclick = async ()=>{
      const newName = modal.querySelector('#editRoomName').value.trim();
      if(!newName) return toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
      await db.ref('rooms/'+roomId).update({ name:newName });
      modal.remove();
      resolve();
    };
  });
}

/* Custom Modals for Initial Setup (unchanged) */
async function openInitialProfileSetup(user){
  return new Promise(resolve => {
    const defaultTag = (user.email?user.email.split('@')[0]:'user');
    const html = `<div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:700">í”„ë¡œí•„ ì„¤ì • (ìµœì´ˆ 1íšŒ)</div>
      <input id="initName" placeholder="í‘œì‹œëª… (ë‹‰ë„¤ì„)" value="${user.displayName||''}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
      <input id="initTag" placeholder="ê³ ìœ  íƒœê·¸ (ì†Œë¬¸ì/ìˆ«ì/_)" value="${defaultTag}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
      <div style="color:red;font-size:12px;text-align:center" id="tagError"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="initOk" class="btn">ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>`;
    const m = openModal(html);
    m.querySelector('#initOk').onclick = async ()=>{
      const name = m.querySelector('#initName').value.trim();
      let tag = m.querySelector('#initTag').value.trim().toLowerCase().replace(/\s+/g,'');
      if(!name) return toast('ë‹‰ë„¤ì„ ì…ë ¥');
      if(!tag) return toast('íƒœê·¸ ì…ë ¥');
      
      const tagRef = db.ref('tags/'+tag);
      const res = await tagRef.transaction(curr=>{ if(curr==null) return user.uid; return; }, undefined, false);
      if(!res.committed) {
         m.querySelector('#tagError').textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íƒœê·¸ì…ë‹ˆë‹¤. ë‹¤ë¥¸ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
         return;
      }
      await db.ref('users/'+user.uid).set({ uid:user.uid, name, tag, photoURL:user.photoURL||'' });
      displayNameEl.textContent = name; displayTagEl.textContent = '#'+tag;
      if(user.photoURL) profileAvatar.src = user.photoURL;
      m.remove();
      resolve();
    };
  });
}
async function openInitialAnonProfileSetup(){
  return new Promise(resolve => {
    const defaultTag = 'guest'+Math.floor(Math.random()*9000);
    const html = `<div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:700">ë¹„íšŒì› í”„ë¡œí•„ ì„¤ì •</div>
      <input id="initName" placeholder="í‘œì‹œëª… (ë‹‰ë„¤ì„)" value="ì†ë‹˜" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
      <input id="initTag" placeholder="ê³ ìœ  íƒœê·¸ (ì†Œë¬¸ì/ìˆ«ì/_)" value="${defaultTag}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="initOk" class="btn">ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>`;
    const m = openModal(html);
    m.querySelector('#initOk').onclick = ()=>{
      const name = m.querySelector('#initName').value.trim();
      const tag = m.querySelector('#initTag').value.trim().toLowerCase().replace(/\s+/g,'');
      const uidv = 'anon_'+Math.random().toString(36).slice(2,8);
      setLocalProfile({ uid:uidv, name, tag, photoURL:'' });
      m.remove();
      resolve();
    };
  });
}

/* Profile modal: edit name/tag, login/logout (unchanged) */
function openProfileModal(){
  const local = getLocalProfile();
  const logged = !!auth.currentUser;
  const html = `
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="display:flex;gap:10px;align-items:center">
        <img id="modalProfileImg" src="${local.photoURL || profileAvatar.src}" style="width:56px;height:56px;border-radius:999px"/>
        <div>
          <div style="font-weight:700" id="modalProfileName">${local.name || 'ë¹„íšŒì›'}</div>
          <div class="text-sm text-gray-500" id="modalProfileTag">#${local.tag || 'â€”'}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="modalEditProfile" class="btn-ghost" style="flex:1">ë‹‰ë„¤ì„/íƒœê·¸ ë³€ê²½</button>
        <button id="modalUploadAvatar" class="btn-ghost" style="flex:1">í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="modalAuthBtn" class="btn-ghost" style="flex:1">${logged? 'ë¡œê·¸ì•„ì›ƒ':'ë¡œê·¸ì¸(êµ¬ê¸€)'}</button>
        <button id="modalClose" class="btn-ghost" style="flex:1">ë‹«ê¸°</button>
      </div>
    </div>`;
  const m = openModal(html);
  m.querySelector('#modalClose').onclick = ()=> m.remove();
  
  // Custom modal for name/tag edit
  m.querySelector('#modalEditProfile').onclick = async ()=>{
    m.remove(); // Close main profile modal first
    const editHtml = `<div style="display:flex;flex-direction:column;gap:8px">
        <div style="font-weight:700">ë‹‰ë„¤ì„/íƒœê·¸ ë³€ê²½</div>
        <input id="editName" placeholder="í‘œì‹œëª… (ë‹‰ë„¤ì„)" value="${local.name||''}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
        <input id="editTag" placeholder="ê³ ìœ  íƒœê·¸ (ì†Œë¬¸ì/ìˆ«ì/_)" value="${local.tag||''}" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
        <div style="color:red;font-size:12px;text-align:center" id="tagError"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="editCancel" class="btn-ghost">ì·¨ì†Œ</button>
          <button id="editOk" class="btn">ë³€ê²½</button>
        </div>
      </div>`;
    const editModal = openModal(editHtml);
    editModal.querySelector('#editCancel').onclick = ()=> editModal.remove();
    editModal.querySelector('#editOk').onclick = async ()=>{
      const newName = editModal.querySelector('#editName').value.trim();
      let newTag = editModal.querySelector('#editTag').value.trim().toLowerCase().replace(/\s+/g,'');

      if(!newName) return toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
      if(!newTag) return toast('ìœ íš¨í•œ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      
      try {
        if(auth.currentUser){
          const tagRef = db.ref('tags/'+newTag);
          const res = await tagRef.transaction(curr=>{
            if(curr!=null && curr!==auth.currentUser.uid) return;
            return auth.currentUser.uid; 
          }, undefined, false);

          if(!res.committed && res.snapshot.val()!==auth.currentUser.uid) { 
             editModal.querySelector('#tagError').textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íƒœê·¸ì…ë‹ˆë‹¤. ë‹¤ë¥¸ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
             return;
          }
          // Delete old tag if changed
          if(local.tag && local.tag !== newTag) {
            await db.ref('tags/' + local.tag).remove();
          }
          await db.ref('users/'+auth.currentUser.uid).update({ name:newName, tag:newTag });
        } else {
          local.name = newName; local.tag = newTag; setLocalProfile(local);
        }
        displayNameEl.textContent = newName; displayTagEl.textContent = '#'+newTag;
        editModal.remove();
        toast('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ë¨');
      } catch(e) {
        toast('ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: '+e.message);
      }
    };
  };

  m.querySelector('#modalUploadAvatar').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = async e=>{
      const f = e.target.files[0]; if(!f) return;
      const ref = storage.ref('profiles/'+Date.now()+'_'+f.name);
      const snap = await ref.put(f);
      const url = await snap.ref.getDownloadURL();
      if(auth.currentUser){ 
        await auth.currentUser.updateProfile({photoURL:url}); 
        await db.ref('users/'+auth.currentUser.uid).update({photoURL:url}); 
      } else { 
        local.photoURL = url; setLocalProfile(local); 
      }
      profileAvatar.src=url;
      m.querySelector('#modalProfileImg').src=url;
      toast('í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œë¨');
    };
    inp.click();
  };
  m.querySelector('#modalAuthBtn').onclick = async ()=>{
    if(auth.currentUser){ // logout
      const uid = auth.currentUser.uid;
      await auth.signOut();
      await db.ref('presence/'+uid).remove().catch(()=>{});
      localStorage.removeItem('local_profile');
      location.reload();
    } else {
      const provider = new firebase.auth.GoogleAuthProvider();
      try{ 
        await auth.signInWithPopup(provider); 
        await ensureProfile(); 
        m.remove(); 
      }catch(e){ 
        toast(e.message) 
      }
    }
  };
}


/* ---------- ensure profile & presence ---------- */
async function ensureProfile(){
  const myUid = auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;
  if(auth.currentUser){
    const u = auth.currentUser;
    const snap = await db.ref('users/'+u.uid).once('value'); const profile = snap.val() || {};
    if(!profile.tag || !profile.name){
      await openInitialProfileSetup(u); 
    } else {
      displayNameEl.textContent = profile.name; displayTagEl.textContent = '#'+profile.tag;
      if(profile.photoURL) profileAvatar.src = profile.photoURL;
    }
    // presence
    const presRef = db.ref('presence/'+u.uid);
    presRef.set({ online:true, ts: now() });
    presRef.onDisconnect().remove();
    // attachInvitationsListener(u.uid); // Invitation removed
  } else {
    if(!localStorage.getItem('local_profile')){
      await openInitialAnonProfileSetup(); 
    }
    const p = getLocalProfile();
    displayNameEl.textContent = p.name; displayTagEl.textContent = '#'+p.tag; 
    if(p.photoURL) profileAvatar.src = p.photoURL;
  }
}

/* ---------- rooms ---------- */
openCreateRoom.addEventListener('click', ()=> openCreateRoomModal() );
function openCreateRoomModal(){
  const modal = openModal(`<div style="display:flex;flex-direction:column;gap:8px">
    <div style="font-weight:700">ë°© ìƒì„±</div>
    <input id="newRoomName" placeholder="ë°© ì´ë¦„" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="createCancel" class="btn-ghost">ì·¨ì†Œ</button>
      <button id="createOk" class="btn">ìƒì„±</button>
    </div>
  </div>`);
  modal.querySelector('#createCancel').onclick = ()=> modal.remove();
  modal.querySelector('#createOk').onclick = async ()=>{
    const name = modal.querySelector('#newRoomName').value.trim(); 
    if(!name) return toast('ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); 
    const rid = 'r_'+Math.random().toString(36).slice(2,8);
    const me = auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;
    // ë°© ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ë°© ë©¤ë²„ë¡œ ì¶”ê°€
    await db.ref('rooms/'+rid).set({ id:rid, name, createdAt: now(), owner:me, members: { [me]: true } });
    modal.remove(); loadRooms();
  };
}

// **ìš”ì²­ì‚¬í•­ ë°˜ì˜: ëª¨ë“  ë°©ì— ìë™ìœ¼ë¡œ ë“¤ì–´ê°€ë„ë¡ ìˆ˜ì •**
async function loadRooms(){
  const allRoomsSnap = await db.ref('rooms').once('value'); 
  const data = allRoomsSnap.val()||{};
  roomsList.innerHTML='';
  const myUid = auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;

  // 1. ëª¨ë“  ë°©ì— í˜„ì¬ ì‚¬ìš©ìë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€
  const updates = {};
  let roomsToAdd = [];
  Object.keys(data).forEach(id => {
    const r = data[id];
    // ë§Œì•½ ë©¤ë²„ ëª©ë¡ì— ì—†ë‹¤ë©´, ì—…ë°ì´íŠ¸ ëª©ë¡ì— ì¶”ê°€
    if (!r.members || !r.members[myUid]) {
      updates['rooms/' + id + '/members/' + myUid] = true;
      roomsToAdd.push(Object.assign({id}, r));
    }
  });

  // DB ì—…ë°ì´íŠ¸ (await í•„ìš” ì—†ìŒ)
  if(Object.keys(updates).length > 0) {
    db.ref().update(updates).then(() => {
      // DB ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ë¡œë“œ (í˜¹ì€ ìƒˆë¡œ ì¶”ê°€ëœ ë°©ë§Œ UIì— ì¶”ê°€)
      // ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œëœ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
      loadRoomsAfterJoin();
    }).catch(error => {
      console.error("Auto-join error:", error);
      loadRoomsAfterJoin(); // ì—ëŸ¬ê°€ ë‚˜ë„ ì¼ë‹¨ í˜„ì¬ ë°© ëª©ë¡ìœ¼ë¡œ ì§„í–‰
    });
  } else {
    // ì´ë¯¸ ëª¨ë“  ë°©ì— ë“¤ì–´ê°€ ìˆë‹¤ë©´ ë°”ë¡œ ë¡œë“œ
    loadRoomsAfterJoin();
  }
}

async function loadRoomsAfterJoin() {
  const finalSnap = await db.ref('rooms').once('value'); 
  const data = finalSnap.val()||{};
  roomsList.innerHTML='';
  const myUid = auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;

  Object.keys(data).sort((a,b)=> (data[a].createdAt||0)-(data[b].createdAt||0)).forEach(id=>{
    const r = data[id];
    // ì´ ì‹œì ì—ì„œëŠ” ëª¨ë“  ë°©ì— ë“¤ì–´ê°€ ìˆê¸° ë•Œë¬¸ì— member ì²´í¬ëŠ” ìƒëµ
    const el = document.createElement('div'); el.className='room-item'; el.dataset.id=id;
    const thumb = r.thumb || 'https://placehold.co/36';
    el.innerHTML = `<img class="avatar" src="${thumb}" /><div style="flex:1"><div style="font-weight:600">${r.name}</div><div class="text-sm text-gray-500">${r.lastMessage?escapeHtml(r.lastMessage.slice(0,48)):'ì„¤ëª… ì—†ìŒ'}</div></div>`;
    
    const actions = document.createElement('div'); actions.style.marginLeft='8px';
    // ì´ˆëŒ€ ë²„íŠ¼ì€ ì´ì œ í•„ìš” ì—†ìœ¼ë‚˜ UI ìœ ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì œê±° (ìš”ì²­ì— ë”°ë¼ ì œê±°í•˜ì§€ ì•Šê³  í…ìŠ¤íŠ¸ ì•„ì´ì½˜ë§Œ ë³€ê²½)
    const inviteBtn = document.createElement('button'); 
    inviteBtn.className='icon-btn'; 
    inviteBtn.textContent='ğŸ‘¤+'; // í…ìŠ¤íŠ¸ ì•„ì´ì½˜
    inviteBtn.title='ì´ˆëŒ€';
    inviteBtn.onclick = (e)=>{ e.stopPropagation(); openInviteModal(id); };
    
    const pencil = document.createElement('button'); 
    pencil.className='icon-btn'; 
    pencil.textContent='âš™'; // í…ìŠ¤íŠ¸ ì•„ì´ì½˜
    pencil.title='ì„¤ì •';
    pencil.onclick = async (e)=>{ 
      e.stopPropagation(); 
      await openEditRoomNameModal(id, r.name); 
      loadRooms(); 
    };
    
    actions.appendChild(inviteBtn); 
    actions.appendChild(pencil);
    el.appendChild(actions);
    el.addEventListener('click', ()=> selectRoom(id));
    roomsList.appendChild(el);
  });
}

/* ---------- invitations: left-bottom list (disabled) ---------- */
function attachInvitationsListener(uid){
  // ê¸°ì¡´ ì´ˆëŒ€ ë¡œì§ì€ ìš”ì²­ì‚¬í•­ì— ë”°ë¼ ë¹„í™œì„±í™”
}

/* ---------- invite modal (send) (unchanged) ---------- */
function openInviteModal(roomId){
  const modal = openModal(`<div style="display:flex;flex-direction:column;gap:8px">
    <div style="font-weight:700">ì´ˆëŒ€ ë³´ë‚´ê¸°</div>
    <input id="inviteTag" placeholder="ìƒëŒ€ íƒœê·¸ ì…ë ¥ (ì˜ˆ: zzapcho)" style="padding:.6rem;border-radius:8px;border:1px solid var(--border)"/>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="inviteCancel" class="btn-ghost">ì·¨ì†Œ</button>
      <button id="inviteSend" class="btn">ë³´ë‚´ê¸°</button>
    </div>
  </div>`);
  modal.querySelector('#inviteCancel').onclick = ()=> modal.remove();
  modal.querySelector('#inviteSend').onclick = async ()=>{
    const tag = modal.querySelector('#inviteTag').value.trim().toLowerCase(); 
    if(!tag) return toast('íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); 
    const tSnap = await db.ref('tags/'+tag).once('value'); 
    if(!tSnap.exists()) return toast('í•´ë‹¹ íƒœê·¸ë¥¼ ê°€ì§„ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.'); 
    const targetUid = tSnap.val();
    
    // **ì´ˆëŒ€ ë°œì†¡ ëŒ€ì‹ , ë°”ë¡œ í•´ë‹¹ ìœ ì €ë¥¼ ë°© ë©¤ë²„ë¡œ ì¶”ê°€**
    await db.ref('rooms/'+roomId+'/members/'+targetUid).set(true);
    
    modal.remove(); 
    toast(tag + 'ë‹˜ì„ ë°©ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.'); // ì´ˆëŒ€ ë°œì†¡ ë©”ì‹œì§€ ë³€ê²½
  };
}

/* ---------- select room & messages ---------- */
// **ìš”ì²­ì‚¬í•­ ë°˜ì˜: ë°© ë‚˜ê°€ê¸° -> DB membersì—ì„œ ì™„ì „íˆ ì‚­ì œ**
leaveRoomBtn.onclick = async ()=>{
  if(await openConfirmModal('ë°© ë‚˜ê°€ê¸°', 'ì •ë§ë¡œ ì´ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ë‚˜ê°€ë©´ ë°© ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
    const myUid = auth.currentUser?auth.currentUser.uid:getLocalProfile().uid;
    // DBì—ì„œ ë©¤ë²„ ì •ë³´ ì‚­ì œ
    await db.ref('rooms/'+currentRoom+'/members/'+myUid).remove();
    // clear chat area and load rooms
    currentRoom = null; roomTitle.textContent = 'â€” ë°© ì„ íƒ â€”'; leaveRoomBtn.style.display='none';
    chatBody.innerHTML = '';
    loadRooms();
    toast('ë°©ì—ì„œ ë‚˜ì™”ìŠµë‹ˆë‹¤. ë°© ëª©ë¡ì—ì„œ í•´ë‹¹ ë°©ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.');
  }
};

async function selectRoom(roomId){
  if(messagesRef && messageListener) messagesRef.off('child_added', messageListener);
  currentRoom = roomId; chatBody.innerHTML=''; roomTitle.textContent='ë¡œë”©...'; roomInfo.textContent='';
  const rs = await db.ref('rooms/'+roomId).once('value'); const meta = rs.val()||{};
  roomTitle.textContent = meta.name || 'ë°©'; roomInfo.textContent = '';
  leaveRoomBtn.style.display='inline-block';
  messagesRef = db.ref('rooms/'+roomId+'/messages');
  messageListener = messagesRef.limitToLast(MSG_LIMIT).on('child_added', snap=>{
    const m = Object.assign({key:snap.key}, snap.val());
    insertMessage(m);
  });
  messagesRef.on('child_changed', snap=>{ const m=Object.assign({key:snap.key}, snap.val()); updateMessageInUI(m); });
  messagesRef.on('child_removed', snap=>{ removeMessageFromUI(snap.key); });
}

/* message grouping & render */
function insertMessage(m){
  const lastBlock = chatBody.lastElementChild;
  const local = getLocalProfile();
  const myUid = auth.currentUser?auth.currentUser.uid:local.uid;
  const isMe = (m.uid && myUid && m.uid===myUid) || (!m.uid && m.author===local.name);
  
  // ê·¸ë£¹í•‘ ê¸°ì¤€: ê°™ì€ ì‘ì„±ì && 5ë¶„ ì´ë‚´
  if(lastBlock && lastBlock.dataset && lastBlock.dataset.author === (m.uid||m.author) && (m.ts - Number(lastBlock.dataset.lastTs) < 5*60*1000)){
    // append bubble to lastBlock stack
    const stack = lastBlock.querySelector('.messages-stack');
    appendBubble(stack, m, isMe);
    lastBlock.dataset.lastTs = m.ts;
  } else {
    // create new block
    const block = document.createElement('div'); block.className='msg-block' + (isMe?' own':'');
    block.dataset.author = m.uid||m.author; block.dataset.lastTs = m.ts;
    
    const avatarCol = document.createElement('div'); avatarCol.className='avatar-col';
    const img = document.createElement('img'); img.className='avatar'; img.src = m.photoURL || (local.photoURL || 'https://placehold.co/88');
    avatarCol.appendChild(img);
    
    const container = document.createElement('div'); container.style.minWidth='120px';
    
    // top meta line: nickname, tag, time (ì™¼ìª½ì—ì„œë¶€í„°)
    const meta = document.createElement('div'); meta.className='meta-line';
    const nameSpan = document.createElement('span'); nameSpan.innerHTML = `<strong>${escapeHtml(m.author||'ìµëª…')}</strong>`;
    const tagSpan = document.createElement('span'); tagSpan.className='text-sm text-gray-500'; tagSpan.textContent = '#'+(m.tag||'â€”');
    const timeSpan = document.createElement('span'); timeSpan.className='text-sm text-gray-500'; timeSpan.textContent = new Date(m.ts).toLocaleTimeString();
    meta.appendChild(nameSpan); meta.appendChild(tagSpan); meta.appendChild(timeSpan);
    
    const stack = document.createElement('div'); stack.className='messages-stack';
    appendBubble(stack, m, isMe);
    
    // actions (show on hover)
    const actions = document.createElement('div'); actions.className='controls'; actions.style.marginTop='6px';
    
    // reply
    const replyBtn = document.createElement('button'); replyBtn.className='icon-btn'; replyBtn.textContent='RE'; replyBtn.title='ë‹µì¥'; // í…ìŠ¤íŠ¸ ì•„ì´ì½˜
    replyBtn.onclick = ()=>{ replyTo = m.key; replyText.textContent = m.text ? m.text.slice(0,120) : '[ì²¨ë¶€]'; replyPreview.style.display='flex'; };
    actions.appendChild(replyBtn);
    
    // edit/delete for own
    if(isMe){
      const edit = document.createElement('button'); edit.className='icon-btn'; edit.textContent='ED'; edit.title='ìˆ˜ì •'; // í…ìŠ¤íŠ¸ ì•„ì´ì½˜
      edit.onclick = async ()=>{ 
        const newText = await openEditMessageModal(m.text||''); 
        if(newText!==null) await db.ref('rooms/'+currentRoom+'/messages/'+m.key).update({ text:newText, edited:true }); 
      };
      const del = document.createElement('button'); del.className='icon-btn delete'; del.textContent='DE'; del.title='ì‚­ì œ'; // í…ìŠ¤íŠ¸ ì•„ì´ì½˜
      del.onclick = async ()=>{ 
        if(await openConfirmModal('ë©”ì‹œì§€ ì‚­ì œ','ì •ë§ë¡œ ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
          await db.ref('rooms/'+currentRoom+'/messages/'+m.key).remove(); 
        }
      };
      actions.appendChild(edit); actions.appendChild(del);
    }
    container.appendChild(meta); container.appendChild(stack); container.appendChild(actions);
    
    // ë‚´ ë©”ì‹œì§€ì¼ ê²½ìš° ìˆœì„œ ë³€ê²½
    if(isMe){
      block.appendChild(container); 
      block.appendChild(avatarCol);
    } else {
      block.appendChild(avatarCol); 
      block.appendChild(container);
    }
    
    chatBody.appendChild(block);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  markRead(m.key);
}

function appendBubble(stack, m, isMe){
  const bubble = document.createElement('div'); bubble.id='msg_'+m.key; bubble.className='bubble ' + (isMe?'own':'other');
  
  // reply snippet inside bubble if m.replyTo
  if(m.replyTo){
    const q = document.createElement('div'); q.className='reply-small'; q.textContent='ë‹µê¸€ ë¡œë”©...'; bubble.appendChild(q);
    db.ref('rooms/'+currentRoom+'/messages/'+m.replyTo).once('value').then(snap=>{
      if(snap.exists()){
        q.textContent = 'ë‹µê¸€ â†’ '+ (snap.val().text||'[ì²¨ë¶€]');
        q.onclick = ()=>{ const tgt = document.getElementById('msg_'+m.replyTo); if(tgt){ tgt.scrollIntoView({behavior:'smooth',block:'center'}); tgt.classList.add('reply-target'); setTimeout(()=>tgt.classList.remove('reply-target'),1200); } };
        // CSS ì¡°ì •ì€ ìœ ì§€
        const len = (snap.val().text||'').length;
        const approx = Math.min(520, Math.max(120, Math.floor(len*6)));
        if(approx > (document.querySelector('.chat-body').clientWidth/3)) { q.style.whiteSpace='normal'; }
        q.style.maxWidth = approx+'px';
      }
    });
  }
  // attachments
  if(m.attachments && Array.isArray(m.attachments)){
    m.attachments.forEach(a=>{
      if(a.type && a.type.startsWith('image/')){
        const img = document.createElement('img'); img.src=a.url; img.style.maxWidth='220px'; img.style.borderRadius='8px'; img.style.display='block'; img.style.marginBottom='6px';
        bubble.appendChild(img);
      } else {
        const link = document.createElement('a'); link.href=a.url; link.target='_blank'; link.textContent=a.name||'íŒŒì¼'; bubble.appendChild(link);
      }
    });
  }
  // text + mentions
  if(m.text){
    let text = escapeHtml(m.text);
    const mentions = (m.text.match(/@([a-zA-Z0-9_]+)/g) || []).map(x=>x.replace('@','').toLowerCase());
    for(const t of mentions){
      text = text.replace(new RegExp('@'+t,'gi'), `<span class="mention-inline">@${t}</span>`);
      const local = getLocalProfile();
      if(local && local.tag && local.tag.toLowerCase()===t){ bubble.style.background = 'var(--mention-bg)'; }
    }
    const wrap = document.createElement('div'); wrap.innerHTML = marked.parse(text); bubble.appendChild(wrap);
  }
  if(m.edited) bubble.innerHTML += '<div class="text-sm text-gray-500">(í¸ì§‘ë¨)</div>';
  stack.appendChild(bubble);
}

/* update / remove */
function updateMessageInUI(m){
  const old = document.getElementById('msg_'+m.key);
  if(!old) return;
  const parent = old.parentElement;
  old.remove();
  appendBubble(parent, m, parent.closest('.msg-block')?.classList.contains('own'));
}
function removeMessageFromUI(key){
  const el = document.getElementById('msg_'+key);
  if(!el) return;
  const parent = el.parentElement;
  el.remove();
  // if parent (stack) empty, remove block
  if(parent && parent.children.length===0){
    const block = parent.closest('.msg-block');
    if(block) block.remove();
  }
}

/* ---------- send message (unchanged) ---------- */
attachBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; selectedFile=f; toast('íŒŒì¼ ì¤€ë¹„ë¨: '+f.name); });

let sending=false;
sendBtn.addEventListener('click', ()=> sendMessage());
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

async function sendMessage(){
  if(!currentRoom) return toast('ë¨¼ì € ë°©ì„ ì„ íƒí•˜ì„¸ìš”');
  if(sending) return;
  sending=true; sendBtn.disabled=true; sendBtn.textContent='ì „ì†¡ì¤‘...';
  const local = getLocalProfile();
  const author = auth.currentUser ? auth.currentUser.displayName : (local.name || 'ìµëª…');
  const uidv = auth.currentUser ? auth.currentUser.uid : local.uid;
  const text = (msgInput.value||'').trim();
  const attachments = [];
  if(selectedFile){ try{ const meta = await uploadFile(selectedFile,'room_'+currentRoom); attachments.push(meta); }catch(e){ toast('ì—…ë¡œë“œ ì‹¤íŒ¨'); sending=false; sendBtn.disabled=false; sendBtn.textContent='ì „ì†¡'; return; } }
  if(!text && attachments.length===0){ sending=false; sendBtn.disabled=false; sendBtn.textContent='ì „ì†¡'; return; }
  const payload = { author, uid:uidv, text:text||'', attachments:attachments.length?attachments:null, ts: now(), edited:false, tag:getLocalProfile().tag || null };
  if(replyTo) payload.replyTo = replyTo;
  await db.ref('rooms/'+currentRoom+'/messages').push(payload);
  await db.ref('rooms/'+currentRoom).update({ lastMessage: text||'[ì²¨ë¶€]', lastTs: now() });
  msgInput.value=''; selectedFile=null; replyTo=null; replyPreview.style.display='none';
  sending=false; sendBtn.disabled=false; sendBtn.textContent='ì „ì†¡';
}

/* upload helper (unchanged) */
async function uploadFile(file,prefix){
  const path = (prefix||'uploads') + '/' + Date.now() + '_' + encodeURIComponent(file.name);
  const ref = storage.ref(path);
  const snap = await ref.put(file);
  const url = await snap.ref.getDownloadURL();
  return { url, name: file.name, size: file.size, type: file.type };
}

/* mark read (unchanged) */
async function markRead(msgKey){
  if(!currentRoom||!msgKey) return;
  const myUid = auth.currentUser ? auth.currentUser.uid : getLocalProfile().uid;
  if(!myUid) return;
  const ref = db.ref('rooms/'+currentRoom+'/messages/'+msgKey+'/reads/'+myUid);
  const snap = await ref.once('value'); if(!snap.exists()) await ref.set(now());
}

/* presence & auth */
auth.onAuthStateChanged(async user=>{
  if(user){ 
    await ensureProfile(); 
    const presRef = db.ref('presence/'+user.uid); 
    presRef.set({ online:true, ts: now() }); 
    presRef.onDisconnect().remove(); 
    loadRooms(); // auth change ì‹œ ë°© ë‹¤ì‹œ ë¡œë“œ
  }
  else {
    await ensureProfile();
    loadRooms(); // anon mode ì‹œ ë°© ë¡œë“œ
  }
});

/* init */
(async function init(){
  // init ë¡œì§ì€ authStateChanged ì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ ë³€ê²½
})();
</script>
</body>
</html>
